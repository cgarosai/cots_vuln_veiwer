<div x-data="tableData()" x-init="loadData()">
    <h1>R√©sultats pour {{guessed_name}}</h1>
    
    {% if cots_list %}
        <!-- Contr√¥les de la table -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="d-flex align-items-center">
                    <label class="me-2">Afficher</label>
                    <select x-model="itemsPerPage" @change="currentPage = 1" class="form-select form-select-sm" style="width: auto;">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                    </select>
                    <span class="ms-2">entr√©es</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex justify-content-end">
                    <div class="input-group" style="width: 250px;">
                        <span class="input-group-text">üîç</span>
                        <input 
                            x-model="searchTerm" 
                            @input="currentPage = 1"
                            type="text" 
                            class="form-control" 
                            placeholder="Rechercher...">
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th @click="sort('name')" class="sortable">
                            Nom
                            <span x-show="sortField === 'name'">
                                <i :class="sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                            </span>
                        </th>
                        <th @click="sort('version')" class="sortable">
                            Version
                            <span x-show="sortField === 'version'">
                                <i :class="sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                            </span>
                        </th>
                        <th @click="sort('cpe')" class="sortable">
                            CPE
                            <span x-show="sortField === 'cpe'">
                                <i :class="sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                            </span>
                        </th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="item in paginatedData" :key="item.cpe">
                        <tr>
                            <td x-text="item.name"></td>
                            <td x-text="item.version"></td>
                            <td>
                                <code x-text="item.cpe"></code>
                            </td>
                        <td class="text-center">
                            <button @click="searchCVE(item.cpe)" 
                                    class="btn btn-primary btn-sm">
                                <i class="fas fa-search"></i> Rechercher
                            </button>
                        </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Informations et pagination -->
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="text-muted">
                    Affichage de <span x-text="startItem"></span> √† <span x-text="endItem"></span> 
                    sur <span x-text="filteredData.length"></span> entr√©es
                    <span x-show="filteredData.length < totalItems">
                        (filtr√© de <span x-text="totalItems"></span> entr√©es au total)
                    </span>
                </div>
            </div>
            <div class="col-md-6">
                <nav x-show="totalPages > 1">
                    <ul class="pagination pagination-sm justify-content-end mb-0">
                        <!-- Pr√©c√©dent -->
                        <li class="page-item" :class="{ disabled: currentPage === 1 }">
                            <button @click="currentPage > 1 && currentPage--" 
                                    class="page-link" 
                                    :disabled="currentPage === 1">Pr√©c√©dent</button>
                        </li>
                        
                        <!-- Pages -->
                        <template x-for="page in visiblePages" :key="page">
                            <li class="page-item" :class="{ active: page === currentPage }">
                                <button @click="currentPage = page" 
                                        class="page-link" 
                                        x-text="page"></button>
                            </li>
                        </template>
                        
                        <!-- Suivant -->
                        <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                            <button @click="currentPage < totalPages && currentPage++" 
                                    class="page-link" 
                                    :disabled="currentPage === totalPages">Suivant</button>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    
    {% else %}
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> Aucun COTS trouv√©.
        </div>
    {% endif %}
</div>


<!-- JavaScript Alpine.js pour la logique de table -->
<script>
function tableData() {
    return {
        // Donn√©es
        rawData: [
            {% for cots in cots_list %}
            {
                name: {{ cots[0]|tojson }},
                version: {{ cots[1]|tojson }},
                cpe: {{ cots[2]|tojson }}
            }{{ "," if not loop.last }}
            {% endfor %}
        ],
        
        // √âtat
        searchTerm: '',
        sortField: 'name',
        sortDirection: 'asc',
        currentPage: 1,
        itemsPerPage: 10,
        
        // M√©thodes
        searchCVE(cpe) {
            const url = `/results/cve?cpe=${encodeURIComponent(cpe)}`;
            window.location.href = url;
        },
        loadData() {
            console.log(`Table charg√©e avec ${this.rawData.length} √©l√©ments`);
        },
        
        sort(field) {
            if (this.sortField === field) {
                this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                this.sortField = field;
                this.sortDirection = 'asc';
            }
            this.currentPage = 1;
        },
        
        // Propri√©t√©s calcul√©es
        get totalItems() {
            return this.rawData.length;
        },
        
        get filteredData() {
            let filtered = this.rawData;
            
            // Filtrage par recherche
            if (this.searchTerm.trim()) {
                const term = this.searchTerm.toLowerCase();
                filtered = filtered.filter(item => 
                    item.name.toLowerCase().includes(term) ||
                    item.version.toLowerCase().includes(term) ||
                    item.cpe.toLowerCase().includes(term)
                );
            }
            
            // Tri
            filtered.sort((a, b) => {
                let aVal = a[this.sortField] || '';
                let bVal = b[this.sortField] || '';
                
                // Tri num√©rique pour les versions si possible
                if (this.sortField === 'version') {
                    const aNum = parseFloat(aVal);
                    const bNum = parseFloat(bVal);
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return this.sortDirection === 'asc' ? aNum - bNum : bNum - aNum;
                    }
                }
                
                // Tri alphab√©tique
                aVal = aVal.toString().toLowerCase();
                bVal = bVal.toString().toLowerCase();
                
                if (this.sortDirection === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });
            
            return filtered;
        },
        
        get totalPages() {
            return Math.ceil(this.filteredData.length / this.itemsPerPage);
        },
        
        get paginatedData() {
            const start = (this.currentPage - 1) * this.itemsPerPage;
            const end = start + this.itemsPerPage;
            return this.filteredData.slice(start, end);
        },
        
        get startItem() {
            if (this.filteredData.length === 0) return 0;
            return (this.currentPage - 1) * this.itemsPerPage + 1;
        },
        
        get endItem() {
            const end = this.currentPage * this.itemsPerPage;
            return Math.min(end, this.filteredData.length);
        },
        
        get visiblePages() {
            const pages = [];
            const total = this.totalPages;
            const current = this.currentPage;
            
            if (total <= 7) {
                for (let i = 1; i <= total; i++) {
                    pages.push(i);
                }
            } else {
                if (current <= 4) {
                    for (let i = 1; i <= 5; i++) pages.push(i);
                    pages.push('...');
                    pages.push(total);
                } else if (current >= total - 3) {
                    pages.push(1);
                    pages.push('...');
                    for (let i = total - 4; i <= total; i++) pages.push(i);
                } else {
                    pages.push(1);
                    pages.push('...');
                    for (let i = current - 1; i <= current + 1; i++) pages.push(i);
                    pages.push('...');
                    pages.push(total);
                }
            }
            
            return pages.filter(p => p !== '...' || pages.indexOf(p) === pages.lastIndexOf(p));
        }
    }
}
</script>
