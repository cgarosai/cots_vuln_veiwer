<div x-data="cveTableData()" x-init="loadData()">
    <h1>R√©sultats pour {{searched}}</h1>
    
    {% if cves %}
        <!-- Contr√¥les de la table -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="d-flex align-items-center">
                    <label class="me-2">Afficher</label>
                    <select x-model="itemsPerPage" @change="currentPage = 1" class="form-select form-select-sm" style="width: auto;">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span class="ms-2">entr√©es</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex justify-content-end">
                    <div class="input-group" style="width: 300px;">
                        <span class="input-group-text">üîç</span>
                        <input 
                            x-model="searchTerm" 
                            @input="currentPage = 1"
                            type="text" 
                            class="form-control" 
                            placeholder="Rechercher CVE, CWE, description...">
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtres rapides -->
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="d-flex gap-2 flex-wrap">
                    <button @click="filterByCVSS('high')" 
                            class="btn btn-sm"
                            :class="cvssFilter === 'high' ? 'btn-danger' : 'btn-outline-danger'">
                        CVSS ‚â• 7.0
                    </button>
                    <button @click="filterByCVSS('medium')" 
                            class="btn btn-sm"
                            :class="cvssFilter === 'medium' ? 'btn-warning' : 'btn-outline-warning'">
                        CVSS 4.0-6.9
                    </button>
                    <button @click="filterByCVSS('low')" 
                            class="btn btn-sm"
                            :class="cvssFilter === 'low' ? 'btn-info' : 'btn-outline-info'">
                        CVSS < 4.0
                    </button>
                    <button @click="clearFilters()" class="btn btn-sm btn-outline-secondary">
                        R√©initialiser
                    </button>
                </div>
            </div>
        </div>

        <!-- Table avec colonnes CVSS Vector -->
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th @click="sort('cve')" class="sortable" style="width: 140px;">
                            CVE
                            <span x-show="sortField === 'cve'">
                                <i :class="sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                            </span>
                        </th>
                        <th @click="sort('cwe')" class="sortable" style="width: 80px;">
                            CWE
                            <span x-show="sortField === 'cwe'">
                                <i :class="sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                            </span>
                        </th>
                        <th @click="sort('summary')" class="sortable">
                            R√©sum√©
                            <span x-show="sortField === 'summary'">
                                <i :class="sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                            </span>
                        </th>
                        <th @click="sort('cvss')" class="sortable text-center" style="width: 90px;">
                            CVSS v3
                            <span x-show="sortField === 'cvss'">
                                <i :class="sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                            </span>
                        </th>
                        <th @click="sort('attackVector')" class="sortable text-center" style="width: 200px;">
                            Vecteur CVSS3
                            <span x-show="sortField === 'attackVector'">
                                <i :class="sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                            </span>
                        </th>
                        <th @click="sort('published')" class="sortable" style="width: 120px;">
                            Publication
                            <span x-show="sortField === 'published'">
                                <i :class="sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                            </span>
                        </th>
                        <th @click="sort('lastModified')" class="sortable" style="width: 120px;">
                            Modification
                            <span x-show="sortField === 'lastModified'">
                                <i :class="sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                            </span>
                        </th>
                        <th @click="sort('exploit')" class="sortable" style="width: 120px;">
                            Exploit
                            <span x-show="sortField === 'exploit'">
                                <i :class="sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                            </span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="item in paginatedData" :key="item.cve">
                        <tr>
                            <td>
                                <a :href="'https://nvd.nist.gov/vuln/detail/' + item.cve" 
                                   target="_blank" 
                                   class="text-decoration-none fw-bold"
                                   x-text="item.cve"></a>
                            </td>
                            <td>
                                <span x-show="item.cwe && !item.cwe.includes('NVD') && !item.cwe.includes('Unknown')">
                                    <a :href="'https://cwe.mitre.org/data/definitions/' + item.cwe.substring(4) + '.html'" 
                                       target="_blank" 
                                       class="badge bg-secondary text-decoration-none"
                                       x-text="item.cwe"></a>
                                </span>
                                <span x-show="!item.cwe || item.cwe.includes('NVD') || item.cwe.includes('Unknown')" 
                                      class="text-muted fst-italic">N/A</span>
                            </td>
                            <td>
                                <div 
                                     :title="item.summary"
                                     x-text="item.summary"></div>
                            </td>
                            <td class="text-center">
                                <span class="badge"
                                      :class="{
                                          'bg-danger': item.cvssScore >= 7.0,
                                          'bg-warning text-dark': item.cvssScore >= 4.0 && item.cvssScore < 7.0,
                                          'bg-info text-dark': item.cvssScore > 0 && item.cvssScore < 4.0,
                                          'bg-secondary': item.cvssScore === 0
                                      }"
                                      x-text="item.cvss || 'N/A'"></span>
                            </td>
                            <td class="text-center">
                                <!-- Vecteurs CVSS3 compacts -->
                                <div class="cvss-vector-container">
                                    <div class="d-flex flex-wrap gap-1 justify-content-center">
                                        <!-- Attack Vector -->
                                        <span class="badge cvss-badge" 
                                              :class="getAttackVectorClass(item.attackVector)"
                                              :title="'Attack Vector: ' + getAttackVectorLabel(item.attackVector)"
                                              x-text="'AV:' + (item.attackVector || 'N/A')"></span>
                                        
                                        <!-- Attack Complexity -->
                                        <span class="badge cvss-badge"
                                              :class="getAttackComplexityClass(item.attackComplexity)" 
                                              :title="'Attack Complexity: ' + getAttackComplexityLabel(item.attackComplexity)"
                                              x-text="'AC:' + (item.attackComplexity || 'N/A')"></span>
                                        
                                        <!-- Privileges Required -->
                                        <span class="badge cvss-badge"
                                              :class="getPrivilegesClass(item.privilegesRequired)"
                                              :title="'Privileges Required: ' + getPrivilegesLabel(item.privilegesRequired)" 
                                              x-text="'PR:' + (item.privilegesRequired || 'N/A')"></span>
                                        
                                        <!-- User Interaction -->
                                        <span class="badge cvss-badge"
                                              :class="getUserInteractionClass(item.userInteraction)"
                                              :title="'User Interaction: ' + getUserInteractionLabel(item.userInteraction)"
                                              x-text="'UI:' + (item.userInteraction || 'N/A')"></span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <small x-text="item.published"></small>
                            </td>
                            <td>
                                <small x-text="item.lastModified"></small>
                            </td>
                            <td>
                                <small x-text="item.exploit ? 'Oui' : 'Non'"></small>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="text-muted">
                    Affichage de <span x-text="startItem"></span> √† <span x-text="endItem"></span> 
                    sur <span x-text="filteredData.length"></span> CVE
                    <span x-show="filteredData.length < totalItems">
                        (filtr√© de <span x-text="totalItems"></span> CVE au total)
                    </span>
                </div>
            </div>
            <div class="col-md-6">
                <nav x-show="totalPages > 1">
                    <ul class="pagination pagination-sm justify-content-end mb-0">
                        <li class="page-item" :class="{ disabled: currentPage === 1 }">
                            <button @click="currentPage > 1 && currentPage--" 
                                    class="page-link" 
                                    :disabled="currentPage === 1">Pr√©c√©dent</button>
                        </li>
                        
                        <template x-for="page in visiblePages" :key="page">
                            <li class="page-item" :class="{ active: page === currentPage }">
                                <button @click="currentPage = page" 
                                        class="page-link" 
                                        x-text="page"></button>
                            </li>
                        </template>
                        
                        <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                            <button @click="currentPage < totalPages && currentPage++" 
                                    class="page-link" 
                                    :disabled="currentPage === totalPages">Suivant</button>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    
    {% else %}
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> Aucune CVE trouv√©e.
        </div>
    {% endif %}
</div>

<script>
function cveTableData() {
    return {
        // Donn√©es avec nouveaux champs
        rawData: [
            {% for cve in cves %}
            {
                cve: {{ cve[0]|tojson }},
                cwe: {{ cve[1]|tojson }},
                summary: {{ cve[2]|tojson }},
                cvss: {{ cve[3]|tojson }},
                cvssScore: parseFloat({{ cve[3]|tojson }}) || 0,
                published: {{ cve[4]|tojson }},
                lastModified: {{ cve[5]|tojson }},
                exploit: {{ cve[6]|tojson }},
                attackComplexity: {{ cve[7]|tojson }},
                attackVector: {{ cve[8]|tojson }},
                privilegesRequired: {{ cve[9]|tojson }},
                userInteraction: {{ cve[10]|tojson }}
            }{{ "," if not loop.last }}
            {% endfor %}
        ],
        
        // √âtat (inchang√©)
        searchTerm: '',
        sortField: 'cvss',
        sortDirection: 'desc',
        currentPage: 1,
        itemsPerPage: 25,
        cvssFilter: null,
        
        // M√©thodes existantes (inchang√©es)
        loadData() {
            console.log(`Table CVE charg√©e avec ${this.rawData.length} vuln√©rabilit√©s`);
        },
        
        sort(field) {
            if (this.sortField === field) {
                this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                this.sortField = field;
                this.sortDirection = ['cvss', 'lastModified', 'published'].includes(field) ? 'desc' : 'asc';
            }
            this.currentPage = 1;
        },
        
        filterByCVSS(level) {
            this.cvssFilter = this.cvssFilter === level ? null : level;
            this.currentPage = 1;
        },
        
        clearFilters() {
            this.searchTerm = '';
            this.cvssFilter = null;
            this.currentPage = 1;
        },
        
        // Nouvelles m√©thodes pour les vecteurs CVSS3
        getAttackVectorClass(av) {
            switch(av) {
                case 'NETWORK': return 'av-network';
                case 'ADJACENT_NETWORK': return 'av-adjacent';  
                case 'LOCAL': return 'av-local';
                case 'PHYSICAL': return 'av-physical';
                default: return 'bg-secondary';
            }
        },
        
        getAttackVectorLabel(av) {
            switch(av) {
                case 'NETWORK': return 'Network';
                case 'ADJACENT_NETWORK': return 'Adjacent Network';
                case 'LOCAL': return 'Local';
                case 'PHYSICAL': return 'Physical';
                default: return 'Unknown';
            }
        },
        
        getAttackComplexityClass(ac) {
            switch(ac) {
                case 'LOW': return 'ac-low';
                case 'HIGH': return 'ac-high';
                default: return 'bg-secondary';
            }
        },
        
        getAttackComplexityLabel(ac) {
            switch(ac) {
                case 'LOW': return 'Low';
                case 'HIGH': return 'High';
                default: return 'Unknown';
            }
        },
        
        getPrivilegesClass(pr) {
            switch(pr) {
                case 'NONE': return 'pr-none';
                case 'LOW': return 'pr-low';
                case 'HIGH': return 'pr-high';
                default: return 'bg-secondary';
            }
        },
        
        getPrivilegesLabel(pr) {
            switch(pr) {
                case 'NONE': return 'None';
                case 'LOW': return 'Low';
                case 'HIGH': return 'High';
                default: return 'Unknown';
            }
        },
        
        getUserInteractionClass(ui) {
            switch(ui) {
                case 'NONE': return 'ui-none';
                case 'REQUIRED': return 'ui-required';
                default: return 'bg-secondary';
            }
        },
        
        getUserInteractionLabel(ui) {
            switch(ui) {
                case 'NONE': return 'None';
                case 'REQUIRED': return 'Required';
                default: return 'Unknown';
            }
        },
        
        // Propri√©t√©s calcul√©es (tri mis √† jour)
        get filteredData() {
            let filtered = this.rawData;
            
            if (this.searchTerm.trim()) {
                const term = this.searchTerm.toLowerCase();
                filtered = filtered.filter(item => 
                    item.cve.toLowerCase().includes(term) ||
                    (item.cwe && item.cwe.toLowerCase().includes(term)) ||
                    item.summary.toLowerCase().includes(term)
                );
            }
            
            if (this.cvssFilter === 'high') {
                filtered = filtered.filter(item => item.cvssScore >= 7.0);
            } else if (this.cvssFilter === 'medium') {
                filtered = filtered.filter(item => item.cvssScore >= 4.0 && item.cvssScore < 7.0);
            } else if (this.cvssFilter === 'low') {
                filtered = filtered.filter(item => item.cvssScore > 0 && item.cvssScore < 4.0);
            }
            
            return this.sortData(filtered);
        },
        
        sortData(data) {
            return [...data].sort((a, b) => {
                let aVal = a[this.sortField];
                let bVal = b[this.sortField];
                
                if (this.sortField === 'cvss') {
                    aVal = a.cvssScore;
                    bVal = b.cvssScore;
                }
                
                else if (this.sortField === 'published' || this.sortField === 'lastModified') {
                    aVal = new Date(aVal || '1970-01-01');
                    bVal = new Date(bVal || '1970-01-01');
                }
                
                else if (this.sortField === 'cwe') {
                    if (!aVal || aVal.includes('NVD')) aVal = 'ZZZZ';
                    if (!bVal || bVal.includes('NVD')) bVal = 'ZZZZ';
                }
                
                // Tri pour les nouveaux champs vecteur
                else if (['attackVector', 'attackComplexity', 'privilegesRequired', 'userInteraction'].includes(this.sortField)) {
                    aVal = (aVal || '').toString().toLowerCase();
                    bVal = (bVal || '').toString().toLowerCase();
                }
                
                else {
                    aVal = (aVal || '').toString().toLowerCase();
                    bVal = (bVal || '').toString().toLowerCase();
                }
                
                if (this.sortDirection === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });
        },
        
        // Propri√©t√©s calcul√©es inchang√©es
        get totalItems() { return this.rawData.length; },
        get totalPages() { return Math.ceil(this.filteredData.length / this.itemsPerPage); },
        get paginatedData() {
            const start = (this.currentPage - 1) * this.itemsPerPage;
            return this.filteredData.slice(start, start + this.itemsPerPage);
        },
        get startItem() {
            return this.filteredData.length === 0 ? 0 : (this.currentPage - 1) * this.itemsPerPage + 1;
        },
        get endItem() {
            const end = this.currentPage * this.itemsPerPage;
            return Math.min(end, this.filteredData.length);
        },
        get visiblePages() {
            const pages = [];
            const total = this.totalPages;
            const current = this.currentPage;
            
            if (total <= 7) {
                for (let i = 1; i <= total; i++) pages.push(i);
            } else {
                if (current <= 4) {
                    for (let i = 1; i <= 5; i++) pages.push(i);
                    pages.push('...');
                    pages.push(total);
                } else if (current >= total - 3) {
                    pages.push(1);
                    pages.push('...');
                    for (let i = total - 4; i <= total; i++) pages.push(i);
                } else {
                    pages.push(1);
                    pages.push('...');
                    for (let i = current - 1; i <= current + 1; i++) pages.push(i);
                    pages.push('...');
                    pages.push(total);
                }
            }
            
            return pages.filter(p => p !== '...' || true);
        }
    }
}
</script>